<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflect</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <style>
        body, html {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }
        .heading {
            text-align: center;
            margin-bottom: 20px;
        }
        .product-select, .language-select {
            margin-bottom: 20px;
        }
        .conversation-box {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .message {
            margin-bottom: 10px;
        }
        .message.coach {
            text-align: left;
            color: green;
        }
        .message.user {
            text-align: right;
            color: blue;
        }
        .input-box {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .input-box button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .input-box button:hover {
            background-color: #0056b3;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 70px;
        }
        nav {
            font-family: 'Roboto', sans-serif;
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: #333;
            padding: 10px 0;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 1000;
        }
        nav a {
            color: white;
            text-decoration: none;
            text-align: center;
            font-size: 25px;
            flex: 1 1 0;
        }
        nav a img {
            display: block;
            margin: 0 auto;
            width: 24px;
            height: 24px;
        }
        nav a:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transition: background-color 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="heading">
            <h1>Reflect</h1>
        </div>
        <div class="language-select">
            <label for="language">Select Language:</label>
            <select id="language" name="language">
                <option value="Hindi">Hindi</option>
                <option value="English">English</option>
            </select>
        </div>
        <div class="product-select">
            <label for="product">Select a Product:</label>
            <select id="product" name="product">
                <option value="">--Select a Product--</option>
            </select>
        </div>
        <div class="input-box">
            <button id="startConversation" onclick="startConversation()">Start Conversation</button>
        </div>

        <div class="conversation-box" id="conversationBox">
            <!-- Conversation messages will be shown here -->
        </div>
        <div class="input-box">
            <button id="startVoice" onclick="startVoiceRecognition()" disabled>Start Voice Recognition</button>
        </div>
    </div>
    <nav>
        <a href="/"><img src="/static/home_icon.png" alt="Home Icon">Home</a>
        <a href="/recall"><img src="/static/recall_icon.png" alt="Recall Icon">Recall</a>
        <a href="/rehearse"><img src="/static/rehearse_icon.png" alt="Rehearse Icon">Rehearse</a>
    </nav>
    <script>
        var csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        var conversationId = null;  // Initialize to null
        var selectedLanguage = "Hindi";  // Default to Hindi

        // Load available products
        function loadProducts() {
            $.ajax({
                url: '/reflect/load-products',
                type: 'GET',
                success: function(response) {
                    var productSelect = $('#product');
                    productSelect.empty();
                    productSelect.append('<option value="">--Select a Product--</option>');
                    response.products.forEach(function(product) {
                        productSelect.append('<option value="' + product.name + '">' + product.name + '</option>');
                    });
                },
                error: function() {
                    alert('Error loading products');
                }
            });
        }
		
		function handleConversationResponse(response) {
			console.log("Full Response Object:", response);  // Log the full response

			// Check if feedback and next question exist (normal conversation flow)
			if (response.feedback_text && response.next_question_text) {
				console.log("Feedback and next question exist.");
				$('#conversationBox').append('<div class="message coach">' + response.feedback_text + '</div>');
				$('#conversationBox').append('<div class="message coach">' + response.next_question_text + '</div>');

				// Play audio for feedback and then next question
				if (response.feedback_audio) {
					playAudioResponse(response.feedback_audio, function() {
						if (response.next_question_audio) {
							playAudioResponse(response.next_question_audio);
						}
					});
				} else if (response.next_question_audio) {
					playAudioResponse(response.next_question_audio);
				}
			}
			// Check if it's the final feedback (end of conversation)
			else if (response.feedback_text && response.is_final_feedback) {
				console.log("End of conversation. Showing final feedback.");
				// Handle final feedback at the end of the conversation
				$('#conversationBox').append('<div class="message coach">' + response.feedback_text + '</div>');
				$('#conversationBox').append('<div class="message coach">Final Feedback: ' + response.final_feedback_text + '</div>');

				// Play final feedback audio if available
				if (response.feedback_audio) {
					playAudioResponse(response.feedback_audio, function() {
						if (response.final_feedback_audio) {
							playAudioResponse(response.final_feedback_audio);
						}
					});
				} else if (response.final_feedback_audio) {
					playAudioResponse(response.final_feedback_audio);
				}
				
				console.log("End of conversation. Showing final feedback.");
			} else if (response.text && response.audio) {
				// Handle the first question (or conversation text)
				$('#conversationBox').append('<div class="message coach">' + response.text + '</div>');
				playAudioResponse(response.audio);
			} else {
				console.error('Error: Missing feedback or next question');
				$('#conversationBox').append('<div class="message coach">Error: Missing feedback or next question</div>');
			}
		}



        // Start the conversation when the user clicks the Start Conversation button
        function startConversation() {
			productName = $('#product').val();
			selectedLanguage = $('#language').val();

			if (!productName) {
				alert('Please select a product');
				return;
			}

			$('#startConversation').prop('disabled', true);

			$.ajax({
				url: '/reflect/conversation/' + encodeURIComponent(productName),
				type: 'POST',
				headers: {
					'X-CSRFToken': csrfToken
				},
				contentType: 'application/json',
				data: JSON.stringify({ language: selectedLanguage }),
				success: function(response) {
					if (response.conversation_id) {
						conversationId = response.conversation_id;
						sessionStorage.setItem('conversation_id', conversationId);  // Save for persistence
					} else {
						console.error('No conversation ID found');
						return;
					}

					// Use the refactored function to handle the response
					handleConversationResponse(response);

					$('#startVoice').prop('disabled', false);
					$('#startConversation').prop('disabled', false);
				},
				error: function() {
					alert('Error starting conversation');
					$('#startConversation').prop('disabled', false);
				}
			});
		}



        // Voice recognition function        
		function startVoiceRecognition() {
			console.log("Voice recognition started...");
			recognition = new webkitSpeechRecognition();
			recognition.lang = $('#language').val() === 'Hindi' ? 'hi-IN' : 'en-US';  // Adjust based on selected language
			recognition.interimResults = false;  // Only get final results
			recognition.continuous = false;  // Stop recognition after the user stops speaking

			// Allow the user a 3-second pause before speech recognition automatically stops
			recognition.maxAlternatives = 1;  // Process only the most likely result
			recognition.onstart = function() {
				console.log("Voice recognition active.");
				$('#startVoice').text('Listening...');  // Update button text
			};

			recognition.onend = function() {
				console.log("Voice recognition stopped.");
				$('#startVoice').text('Start Voice Recognition');  // Reset button text
			};

			recognition.onspeechend = function() {
				// Add a delay to allow for pauses before the recognition session ends
				setTimeout(function() {
					recognition.stop();  // Stop recognition after 3 seconds of silence
				}, 3000);  // 3-second delay to allow for pauses
			};

			recognition.onresult = function(event) {
				var transcript = event.results[0][0].transcript;
				console.log("Recognized speech:", transcript);
				$('#conversationBox').append(`<div class="message user">${transcript}</div>`);
				sendUserMessage(transcript);  // Send the user's message to the back-end
			};

			recognition.onerror = function(event) {
				console.error("Speech recognition error: " + event.error);
			};

			recognition.start();
		}


        // Send user's message to validate the answer
        function sendUserMessage(transcript) {
			if (!transcript || transcript.trim() === '') {
				console.error('No message content to send');
				return;
			}

			if (!conversationId) {
				console.error('No conversation ID found');
				return;
			}
			
			console.log("Sending payload:", {
				conversation_id: conversationId,
				message: transcript,
				language: $('#language').val()
			});


			$.ajax({
				url: '/reflect/conversation/' + encodeURIComponent(productName),
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify({
					message: transcript,
					language: $('#language').val()
				}),
				headers: {
					"X-CSRFToken": $('meta[name="csrf-token"]').attr('content')
				},
				success: function(response) {
					handleConversationResponse(response);

					if (!response.conversation_id) {
						console.log("Conversation has ended.");
						$('#startVoice').prop('disabled', true);
					}
				},
				error: function(xhr, status, error) {
					console.error('Error validating user message:', error);
					$('#conversationBox').append('<div class="message coach">Error validating your message. Please try again.</div>');
				}
			});
		}





        // Play audio function with callback
        function playAudioResponse(audioUrl, callback) {
            var audioPlayer = new Audio(audioUrl);
            audioPlayer.controls = true;  // Enable audio controls if needed
            audioPlayer.onended = function() {
                if (callback) {
                    callback();  // Call the callback after the audio finishes
                }
            };
            audioPlayer.play();
        }

        $(document).ready(function() {
            loadProducts();
        });
    </script>
</body>
</html>